<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ngrok搭建和使用 | glin</title>

  
  <meta name="author" content="lin">
  

  
  <meta name="description" content="&amp;emsp;&amp;emsp;组了个NAS，之前宽带是有外网ip并且段口没有限制，可以很愉快的玩owncloud，以及openvpn到家做更多的事儿。换了个宽带只后虽然还有外网ip，但是并没什么用，端口都不通。所以就想起做个内网穿透，刚好有个梯子VPS（慢死，折腾什么劲）。&amp;emsp;&amp;emsp;其实内网">
  

  
  
  <meta name="keywords" content="ngrok,内网穿透">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="ngrok搭建和使用"/>

  <meta property="og:site_name" content="glin"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="glin" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">glin</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>ngrok搭建和使用</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/05/17/ngrok搭建和使用/" rel="bookmark">
        <time class="entry-date published" datetime="2017-05-17T02:23:25.000Z">
          2017-05-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>&emsp;&emsp;组了个NAS，之前宽带是有外网ip并且段口没有限制，可以很愉快的玩owncloud，以及openvpn到家做更多的事儿。换了个宽带只后虽然还有外网ip，但是并没什么用，端口都不通。所以就想起做个内网穿透，刚好有个梯子VPS（慢死，折腾什么劲）。<br>&emsp;&emsp;其实内网穿透有很多方法</p>
<ul>
<li>ssh隧道：不稳定易断</li>
<li>n2n：访问者需要客户端，或者需要其他工具在vps做一次内部端口转发（没用过）</li>
<li>ngrok、frp等开发内网穿透工具</li>
</ul>
<p>&emsp;&emsp;这次选择ngrok。<br>&emsp;&emsp;ngrok服务端安装在有外网ip的机器上，访问者可以直接访问<br>&emsp;&emsp;ngrok客户端安装在nat后的机器上，这是应用服务的真正提供者。<br>&emsp;&emsp;访问者访问外网主机，外网主机只做请求转发，由内网主机真正提供服务。</p>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>&emsp;&emsp;官方提供的服务是2+，开源的ngrok版本是1.7，并且需要自己编译<br>&emsp;&emsp;ngrok服务端是一台VPS，系统Debian<br>&emsp;&emsp;ngrok客户端是家里的台式机，系统Debian，只需要编译一次ngrok</p>
<h3 id="安装GO"><a href="#安装GO" class="headerlink" title="安装GO"></a>安装GO</h3><p>&emsp;&emsp;使用apt安装的go是1.3版本，在编译中会出现错误，需要手动安装go1.7+，这里的安装过程是参考<a href="https://golang.org/doc/install" target="_blank" rel="external">GO官方文档</a>的</p>
<p>&emsp;&emsp;如果已经使用apt安装了go，需要先卸载<code>apt-get remove golang</code></p>
<ul>
<li><p>下载解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://storage.googleapis.com/golang/go1.7.5.linux-amd64.tar.gz</div><div class="line">tar -C /usr/local -xzf go1.7.5.linux-amd64.tar.gz</div></pre></td></tr></table></figure>
</li>
<li><p>配置环境变量<br>编辑$HOME/.bash_profile 添加 <code>export PATH=$PATH:/usr/local/go/bin</code>，然后执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source $HOME/.bash_profile</div></pre></td></tr></table></figure>
<p>验证是否安装成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">go version</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="编译ngrok"><a href="#编译ngrok" class="headerlink" title="编译ngrok"></a>编译ngrok</h3><ul>
<li><p>安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install build-essential mercurial git</div></pre></td></tr></table></figure>
</li>
<li><p>下载源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/inconshreveable/ngrok.git ngrok</div><div class="line">cd ngrok</div></pre></td></tr></table></figure>
</li>
<li><p>生成证书<br>&emsp;&emsp;需要注意的是此处的证书是ngrok上的，意思就是所有经ngrok转发的web使用该证书，无需在转发目标机器的nginx或apach上安装https证书。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">NGROK_DOMAIN=&quot;imququ.com&quot;</div><div class="line"></div><div class="line">openssl genrsa -out base.key 2048</div><div class="line">openssl req -new -x509 -nodes -key base.key -days 10000 -subj &quot;/CN=$NGROK_DOMAIN&quot; -out base.pem</div><div class="line">openssl genrsa -out server.key 2048</div><div class="line">openssl req -new -key server.key -subj &quot;/CN=$NGROK_DOMAIN&quot; -out server.csr</div><div class="line">openssl x509 -req -in server.csr -CA base.pem -CAkey base.key -CAcreateserial -days 10000 -out server.crt</div><div class="line"></div><div class="line">cp base.pem assets/client/tls/ngrokroot.crt</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;目前的ngrok版本只能使用x509，另一篇<a href="/2017/05/15/使用acme-tiny获取Let-s-Encrypt免费HTTPS证书/" title="使用Let's Encrypt">使用Let's Encrypt</a>的文章，其中使用的是sha256，不知道怎么统一，所以我将letsencrypt签好的https证书安装在转发目标机器，ngrok直接使用tcp转发，放弃ngrok中的http和https转发。</p>
</li>
<li><p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo make release-server release-client</div></pre></td></tr></table></figure>
<p>ngrok/bin 目录下应该有 ngrok、ngrokd 两个可执行文件，则编译成功。<br>ngrokd是服务端程序，ngrok是客户端程序。</p>
</li>
</ul>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><ul>
<li><p>服务端<br>指定域名、http端口，https端口，以及证书 启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ./bin/ngrokd -tlsKey=server.key -tlsCrt=server.crt -domain=&quot;imququ.com&quot; -httpAddr=&quot;:8081&quot; -httpsAddr=&quot;:8082&quot;</div></pre></td></tr></table></figure>
<p>我不打算使用它的http和https，可以给空字符串以禁用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ./bin/ngrokd -tlsKey=server.key -tlsCrt=server.crt -domain=&quot;imququ.com&quot; -httpAddr=&quot;&quot; -httpsAddr=&quot;&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>客户端</p>
<ol>
<li><p>使用http和https<br>写一个简单的配置文件<code>ngrok.cfg</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server_addr: imququ.com:4443</div><div class="line">trust_host_root_certs: false</div><div class="line">inspect_addr: 10.0.0.10:4040</div></pre></td></tr></table></figure>
<p>其中的4443端口是服务端监听客户端接入的端口，可以在启动服务端的时候使用参数<br><code>-tunnelAddr=&quot;:xxx&quot;</code>更改。inspect_addr是监控界面地址，默认为127.0.0.1:4040，这样局域网内其他电脑无法访问只有自己可以访问(Debian系统没装xwindows)，所以可修改为局域网ip或者0.0.0.0。</p>
<p>启动客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#将服务器的http请求转发到本地80端口,即8081-&gt;80转发</div><div class="line">./ngrok -subdomain pub -proto=http -config=ngrok.cfg 80</div><div class="line">#将服务器的https请求转发到本地443端口，即8082-&gt;443转发</div><div class="line">./ngrok -subdomain pub -proto=https -config=ngrok.cfg 443</div></pre></td></tr></table></figure>
<p>这样就可以使用<a href="http://pub.imququ.com，https://pub.imququ.com" target="_blank" rel="external">http://pub.imququ.com，https://pub.imququ.com</a> 访问</p>
</li>
<li><p>使用tcp或其他<br>丰富一下配置文件<code>ngrok.cfg</code>，假设定义了两个tunnel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">server_addr: imququ.com:4443</div><div class="line">trust_host_root_certs: false</div><div class="line">inspect_addr: 10.0.0.10:4040</div><div class="line">tunnels:</div><div class="line">    myapp:</div><div class="line">        remote_port: 8087</div><div class="line">        proto:</div><div class="line">            tcp: 80</div><div class="line">    openvpn:</div><div class="line">        remote_port: 1194</div><div class="line">        proto:</div><div class="line">            tcp: 1194</div></pre></td></tr></table></figure>
<p>启动客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#启动myapp，即将服务端8087转发到本地80</div><div class="line">./ngrok -config=ngrok.cfg start myapp</div><div class="line">#启动openvpn，即将服务端1194端口转发到本地1194</div><div class="line">./ngrok -config=ngrok.cfg start openvpn</div></pre></td></tr></table></figure>
<p>支持tcp转发，可玩性比较高。</p>
</li>
</ol>
</li>
</ul>
<h2 id="管理界面"><a href="#管理界面" class="headerlink" title="管理界面"></a>管理界面</h2><p> &emsp;&emsp;ngrok客户端提供了一个web界面，可以用来监控http和https转发的详细信息，不能监控其他协议转发的内容，比如tcp。监控地址<a href="http://127.0.0.1:4040" target="_blank" rel="external">http://127.0.0.1:4040</a> ，地址可以修改，参考样例客户端配置文件ngrok.cfg</p>
<hr>
<p>最后，慢归慢，但是断了会自动重连，owncloud上传文件还可以接受，毕竟绕了一大圈。</p>
<blockquote>
<p>本文参考链接<a href="https://imququ.com/post/self-hosted-ngrokd.html" target="_blank" rel="external">https://imququ.com/post/self-hosted-ngrokd.html</a></p>
</blockquote>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/ngrok/">ngrok</a><a href="/tags/内网穿透/">内网穿透</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2017 lin
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>
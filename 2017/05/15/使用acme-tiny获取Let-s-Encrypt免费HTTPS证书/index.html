<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>使用acme-tiny获取Let&#39;s Encrypt免费HTTPS证书 | glin</title>

  
  <meta name="author" content="lin">
  

  
  <meta name="description" content="&amp;emsp;&amp;emsp;证书签发服务Let’s Encrypt提供免费的https证书，但是证书有效期只有90天，因此获取证书后，每90天刷新，获取新证书，官方有提供工具，但是并不好用。第三方的工具也有一大把，个人认为最好用的就是acme-tiny，基于python，几百行的脚本就可以完成获取证书、">
  

  
  
  <meta name="keywords" content="acme-tiny,Let&#39;s Encrypt,letsencrypt,https证书">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="使用acme-tiny获取Let&#39;s Encrypt免费HTTPS证书"/>

  <meta property="og:site_name" content="glin"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="glin" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">glin</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>使用acme-tiny获取Let&#39;s Encrypt免费HTTPS证书</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/05/15/使用acme-tiny获取Let-s-Encrypt免费HTTPS证书/" rel="bookmark">
        <time class="entry-date published" datetime="2017-05-15T09:54:25.000Z">
          2017-05-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>&emsp;&emsp;证书签发服务<a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>提供免费的https证书，但是证书有效期只有90天，因此获取证书后，每90天刷新，获取新证书，官方有提供工具，但是并不好用。第三方的工具也有一大把，个人认为最好用的就是<a href="https://github.com/diafygi/acme-tiny" target="_blank" rel="external">acme-tiny</a>，基于python，几百行的脚本就可以完成获取证书、刷新证书。</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>linux系统</li>
<li>安装有python</li>
<li>一个外网可访问的web服务器，apache、nginx，端口必须是80。自己用node或python也可以创建一个简单容器（参考其他文档）</li>
</ul>
<h2 id="获取证书"><a href="#获取证书" class="headerlink" title="获取证书"></a>获取证书</h2><ul>
<li><p><strong>Stp 1：创建一个账户key</strong><br>&emsp;&emsp;先创建一个文件夹，用来放置生成过程中的各种文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir letsencrypt</div><div class="line">cd letsencrypt</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;如果以前使用过Let’s Encrypt，保留着<code>account.key</code>，<code>domain.key</code>，<code>domain.csr</code>，只是想刷新域名，请从“Step 3：获取签名证书”开始</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ openssl genrsa 4096 &gt; account.key</div></pre></td></tr></table></figure>
</li>
</ul>
<p>&emsp;&emsp;账户key是用来让Let’s Encrypt识别你的身份的，在以后的刷新证书中需要，代表证书签约者身份</p>
<ul>
<li><strong>Step 2：生成证书签名请求（certificate signing request － CSR）</strong></li>
</ul>
<p>&emsp;&emsp;Let’s Encrypt使用的ACME协议，需要提交一个CSR文件，包括刷新证书，可以使用相同的CSR刷新多次</p>
<ol>
<li><p>创建一个domain-key，不能将账户key用作域名key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ openssl genrsa 4096 &gt; domain.key</div></pre></td></tr></table></figure>
</li>
<li><p>生成CSR</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#单个域名</div><div class="line">$ openssl req -new -sha256 -key domain.key -subj &quot;/CN=yoursite.com&quot; &gt; domain.csr</div><div class="line">#多个域名</div><div class="line">$ openssl req -new -sha256 -key domain.key -subj &quot;/&quot; -reqexts SAN -config &lt;(cat /etc/ssl/openssl.cnf &lt;(printf &quot;[SAN]\nsubjectAltName=DNS:yoursite.com,DNS:www.yoursite.com&quot;)) &gt; domain.csr</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;根据实际情况以上命令任选其一，Let’s Encrypt的限制，不能使用域名泛解析，并且一个证书最多100个域名。多个域名时，添加的每个域名需要指向同一ip，在后面的验证域名身份时，每个域名都会验证一次</p>
</li>
</ol>
<ul>
<li><strong>Step 3：获取签名证书</strong></li>
</ul>
<ol>
<li><p>搭建临时web服务器<br>&emsp;&emsp;Let’s Encrypt要验证你是不是域名的真正拥有者，在获取证书的过程中，Let’s Encrypt会请求一个类似这样的链接<br><code>http://yoursite.com/.well-known/acme-challenge/xxxxxxxxxxx</code><br>如果链接所指向的文件可访问，则认为域名是你的，当然这个文件内容不是固定的，也是在获取证书的过程中生成的。<br>&emsp;&emsp;因此需要你将域名解析到外网可访问的web服务器上，准确的说是要国外都可以访问，因为Let’s Encrypt服务器是上述地址的访问者，所以国内的主机或者你家里的主机，要确保国外可以访问（如果你的CSR中含有多个域名，每个域名都要解析到该web服务器，因为Let’s Encrypt会把每个域名相应的地址都会访问验证一次，确保你都是域名拥有者）。<br>&emsp;&emsp;假如现有web服务器，最简单的做法就是在web服务器根下创建文件夹 <code>.well-known/acme-challenge/</code>，记住此文件夹的绝对路径，假如是<code>/var/www/html/.well-known/acme-challenge/</code>。<br>&emsp;&emsp;也可以在nginx中配置一个规则，例如，此时的绝对路径为<code>/var/www/challenges/</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#example for nginx</div><div class="line">   server &#123;</div><div class="line">       listen 80;</div><div class="line">       server_name yoursite.com www.yoursite.com;</div><div class="line"></div><div class="line">       location /.well-known/acme-challenge/ &#123;</div><div class="line">           alias /var/www/challenges/;</div><div class="line">           try_files $uri =404;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       ...the rest of your config</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>获取证书<br>从gitbub下载acme_tiny，其实就是一个python脚本，单文件，放置在当前目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python acme_tiny.py --account-key ./account.key --csr ./domain.csr --acme-dir /var/www/html/.well-known/acme-challenge/ &gt; ./signed.crt</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;命令中需要指定<code>account.key</code>，<code>domain.csr</code>，和验证域名文件存放路径<code>--acme-dir</code>设置为上一步创建的文件夹，需要绝对路径。生成的证书文件保存在当前文件夹下，文件名 <code>signed.crt</code><br>&emsp;&emsp;创建域名验证文件和访问域名验证都是在这个命令中一气呵成，所以执行命令的机器和web服务器需在同一主机</p>
</li>
<li><p>合并中间证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem &gt; intermediate.pem</div><div class="line">cat signed.crt intermediate.pem &gt; chained.pem</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;chained.pem即是最终的https证书，是最终在应用web容器中配置的证书。</p>
</li>
</ol>
<ul>
<li><p><strong>Step 4：安装证书</strong></p>
<p>&emsp;&emsp;不同的web容器安装方式不同，依nginx为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"> server &#123;</div><div class="line">    listen 443;</div><div class="line">    server_name yoursite.com, www.yoursite.com;</div><div class="line"></div><div class="line">    ssl on;</div><div class="line">    ssl_certificate /path/to/chained.pem;</div><div class="line">    ssl_certificate_key /path/to/domain.key;</div><div class="line">    ssl_session_timeout 5m;</div><div class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA;</div><div class="line">    ssl_session_cache shared:SSL:50m;</div><div class="line">    ssl_dhparam /path/to/server.dhparam;</div><div class="line">    ssl_prefer_server_ciphers on;</div><div class="line"></div><div class="line">    ...the rest of your config</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    server_name yoursite.com, www.yoursite.com;</div><div class="line"></div><div class="line">    location /.well-known/acme-challenge/ &#123;</div><div class="line">        alias /var/www/challenges/;</div><div class="line">        try_files $uri =404;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...the rest of your config</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;刚才的过程中会生成很多文件，需要配置在应用web容器上的其实就<code>chained.pem</code>和<code>domain.key</code>，但是其他文件都有用，<strong>需要保留和备份</strong></p>
</li>
</ul>
<ul>
<li><p><strong>Step 5：刷新证书</strong><br>&emsp;&emsp;证书有效期只有90天，所以在证书快要过期的时候，需要刷新证书，给证书续期。可以写成shell脚本，使用linux的crontab定时执行。<br>&emsp;&emsp;创建shell脚本<code>renew_cert.sh</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> #!/usr/bin/sh</div><div class="line">python /path/to/acme_tiny.py --account-key /path/to/account.key --csr /path/to/domain.csr --acme-dir /var/www/html/.well-known/acme-challenge/ &gt; /tmp/signed.crt || exit</div><div class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem &gt; intermediate.pem</div><div class="line">cat /tmp/signed.crt intermediate.pem &gt; /path/to/chained.pem</div><div class="line">service nginx reload</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;可以看到以上命令，刷新证书其实就是从获取证书步骤开始再来一遍，需要之前生成的账户key <strong><code>account.key</code></strong>，证书签名请求CSR <strong><code>domain.csr</code></strong>，以及用来验证域名属于你的临时web服务器。当然你可以将你的应用web服务器用作验证域名用的临时服务器。</p>
<p>&emsp;&emsp;创建crontab，例如每月执行一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0 0 1 * * /path/to/renew_cert.sh 2&gt;&gt; /var/log/acme_tiny.log</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;需要注意的地方:<br>&emsp;&emsp;  1.验证域名的challenge文件夹的安全性，不知道和应用服务器放置在一起会有什么问题，期望高人来解答。这也是Let’s Encrypt让人比较头疼的地方，刷新域名仍需验证，而且还要占用80端口。<br>&emsp;&emsp;  2.注意<code>account.key</code>，<code>domain.key</code>的保密和备份<br>&emsp;&emsp;  3.acme-tiny官方给的建议是，刷新脚本用一个特殊的用户，最大的权限是读取<code>account.key</code>、读写challenge文件夹、读写web服务器证书文件的权限（例如/path/to/chained.pem），以及reload web服务器的权限</p>
</li>
</ul>
<blockquote>
<p>本文参考链接<a href="https://github.com/diafygi/acme-tiny" target="_blank" rel="external">https://github.com/diafygi/acme-tiny</a></p>
</blockquote>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/acme-tiny/">acme-tiny</a><a href="/tags/Let-s-Encrypt/">Let's Encrypt</a><a href="/tags/letsencrypt/">letsencrypt</a><a href="/tags/https证书/">https证书</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2017 lin
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>